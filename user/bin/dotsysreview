#!/bin/bash

set -o errexit -o nounset

# System maintenance script
# Ref: https://wiki.archlinux.org/index.php/System_maintenance
# Ref: https://wiki.archlinux.org/index.php/Pacman/Tips_and_tricks
# Ref: https://wiki.archlinux.org/index.php/Pacman/Pacnew_and_Pacsave

heading() { echo "$(tput smso)$*$(tput rmso)"; }

# List packages from dotfiles.
packages_dotfiles() {
    sed -e '/^#.*/d' -e '/^$/d' \
        "${BASH_SOURCE%/*}/../../$HOSTNAME/packages/"*.pkgs \
        | sort
}

# List explicitly installed packages and groups. Packages belonging to the
# specified groups are hidden.
packages_installed() {
    local groups=(base-devel texlive-most)
    comm -23 \
        <({ pacman -Qq --explicit;
            tr ' ' '\n' <<< "${groups[@]}"; } | sort) \
        <(pacman -Qq --groups "${groups[@]}" | sort)
}

{
    heading '# Packages: pacnew & pacsave'
    fd --color=always '\.(pacnew|pacsave)' '/etc'

    echo; heading '# Packages: diff dotfiles vs installed'
    diff --color=always --unified=0 <(packages_dotfiles) <(packages_installed) \
        | sed -e '1,2d' -e '/@@/d'

    echo; heading '# Packages: unused dependencies'
    pacman -Qq --deps --unrequired || :

    echo; heading '# Services: system'
    systemctl --type=service || :

    echo; heading '# Services: user'
    systemctl --type=service --user || :;

    echo; heading '# Packages: logs from last full upgrade'
    tac /var/log/pacman.log | sed '/-S -u -y/q' | tac
} | less
