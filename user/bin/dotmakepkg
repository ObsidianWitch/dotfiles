#!/bin/bash

set -o errexit -o nounset -o xtrace

# Copy a package ($1) in the 'build' user home, build it and install it.
# Note: the user 'build' need to be added with a home. The user 'nobody' could
# have been used but it doesn't have a home, which prevents certain packages
# from being built (e.g. rust packages).
dotmakepkg() {
    local buildp="/home/build/$RANDOM"
    mkdir -p "$buildp"
    cp -r "$1/." -t "$buildp"
    chown -R build:build "$buildp"
    ( cd "$buildp"
      su build -c 'makepkg'
      pacman -U ./*.pkg.tar.zst; )
    rm -r "$buildp"
}

dotmakepkg "$@"
