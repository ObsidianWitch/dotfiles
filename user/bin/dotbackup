#!/bin/bash

set -o errexit -o nounset

# External drive: fs encrypted w/ dm-crypt
# * rsync home including borg ~/Snapshots (encryption=none)
backup_extdrive() {
    local out="/run/media/$USER/extyayaka"
    dotborg snapshot '' 'backup_extdrive'
    dotborg check
    rsync --archive --delete --protect-args --progress \
        --exclude='.cache' "$HOME" "$out"
}

# Phone SD card: no encryption
# * rsync entertainment
# * borg export-tar | gpg symmetric
backup_phone() {
    local out="/run/media/$USER/C2C2-14E6/"
    rsync --recursive --delete --protect-args --progress --size-only \
          "$HOME/Downloads" "$HOME/Music" "$HOME/.dotprivate" "$out"
    dotborg export-tar --progress "::$(dotborg head)" - \
        |  gpg --symmetric --output "$out/borg.tar.enc"
}

help() {
    echo 'usage: dotbackup extdrive'
    echo '       dotbackup phone'
    exit 1
}

[[ -n "${1:-}" ]] || help
if [[ "$1" == "extdrive" ]]; then
    backup_extdrive
elif [[ "$1" == "phone" ]]; then
    backup_phone
else
    help
fi
