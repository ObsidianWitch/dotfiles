#!/bin/bash

set -o errexit -o nounset

backup_local() {
    local repository="/run/media/$USER/yayaka_storage/$USER"
    borg init --encryption='repokey-blake2' "$repository" || :
    borg create "${repository}::{now}" "$HOME" \
        --exclude="$HOME/.cache" \
        --exclude="$HOME/.dotprivate/plaintext" \
        --progress --stats
    borg prune "$repository" --keep-last='24' --stats
}

sync_phone() {
    local out="/run/media/$USER/C2C2-14E6/"
    rsync --archive --delete --protect-args --progress --size-only \
          "$HOME/Downloads" \
          "$HOME/Music" \
          "$HOME/.dotprivate/keepass" \
          "$out"

    local repository="$out/borg"
    borg init --encryption='repokey-blake2' "$repository" || :
    borg create "${repository}::{now}" \
        "$HOME/.dotfiles" \
        "$HOME/.dotprivate" \
        --exclude="$HOME/.dotprivate/plaintext" \
        --progress --stats
    borg prune "$repository" --keep-last='24' --stats
}

help() {
    echo 'usage: dotbackup local'
    echo '       dotbackup phone'
    exit 1
}

[[ -n "${1:-}" ]] || help
if [[ "$1" == "local" ]]; then
    backup_local
elif [[ "$1" == "phone" ]]; then
    sync_phone
else
    help
fi
