#!/bin/bash

set -o errexit -o nounset

backup_borg() {
    mount | grep "$HOME/.dotprivate/encrypted" || {
        echo -n 'Mount dotprivate: '
        dotprivate mount
    }
    borg init --encryption='repokey-blake2' "$1" || :
    borg create "${1}::{now}" \
        "$HOME/.dotfiles" \
        "$HOME/.dotprivate" \
        "$HOME/.mozilla" \
        --progress --stats
}

backup_extdrive() {
    local out="/run/media/$USER/yayaka_storage/$USER"
    rsync --archive --delete --protect-args --progress \
        --exclude='.cache' \
        --exclude=".dotprivate/plaintext" \
        "$HOME/" "$out/rsync"

    backup_borg "$out/borg"
}

backup_phone() {
    local out="/run/media/$USER/C2C2-14E6/"
    rsync --archive --delete --protect-args --progress --size-only \
          "$HOME/Downloads" \
          "$HOME/Music" \
          "$HOME/.dotprivate/keepass" \
          "$out/rsync"

    backup_borg "$out/borg"
}

help() {
    echo 'usage: dotbackup extdrive'
    echo '       dotbackup phone'
    exit 1
}

[[ -n "${1:-}" ]] || help
if [[ "$1" == "extdrive" ]]; then
    backup_extdrive
elif [[ "$1" == "phone" ]]; then
    backup_phone
else
    help
fi
