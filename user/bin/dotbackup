#!/bin/bash

set -o errexit -o nounset

backup_local() {
    dotprivate umount || :
    rsync --archive --delete --prune-empty-dirs --protect-args --progress \
          --exclude='.cache' \
          "$HOME/" "/run/media/$USER/yayaka_storage/$USER"
}

restore_local() {
    rsync --archive --protect-args --progress \
          "/run/media/$USER/yayaka_storage/$USER/" "$HOME"
}

backup_archive() {
    local out; out="$(date +'b%y%m%d.tar')"
    [[ -f "$out" ]] && doterr "$PWD/$out already exists"

    dotprivate umount || :
    tar --create --verbose --preserve-permissions \
        "$HOME/.dotfiles" \
        "$HOME/.dotprivate" \
        --file="$out"
}

sync_phone() {
    local out="/run/media/$USER/C2C2-14E6/"
    rsync --archive --delete --prune-empty-dirs --protect-args --progress \
          --size-only \
          "$HOME/Downloads" \
          "$HOME/Music" \
          "$HOME/.dotprivate/keepass" \
          "$out"

    # faster to backup one big file than many small ones especially on a poor
    # quality SD card
    (cd "$out"; backup_archive)
}

help() {
    echo 'usage: dotbackup local'
    echo '       dotbackup archive'
    echo '       dotbackup phone'
    exit 1
}

[[ -n "${1:-}" ]] || help
if [[ "$1" == "local" ]]; then
    backup_local
elif [[ "$1" == "archive" ]]; then
    backup_archive
elif [[ "$1" == "phone" ]]; then
    sync_phone
else
    help
fi
