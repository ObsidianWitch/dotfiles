#!/bin/bash

set -o errexit -o nounset

block_pa_in() {
    case "${button:-}" in
        1) pamixer --default-source --toggle-mute;;
        3) pavucontrol;;
        4) pamixer --default-source --increase 5;;
        5) pamixer --default-source --decrease 5;;
    esac
    echo "$(pamixer --default-source --get-mute --get-volume \
            | sed -e 's/false//' -e 's/true//')%"
}

block_pa_out() {
    case "${button:-}" in
        1) pamixer --toggle-mute;;
        3) pavucontrol;;
        4) pamixer --increase 5;;
        5) pamixer --decrease 5;;
    esac
    echo "$(pamixer --get-mute --get-volume \
            | sed -e 's/false//' -e 's/true//')%"
}

block_brightness() {
    case "${button:-}" in
        4) xbacklight -steps 1 +5;;
        5) xbacklight -steps 1 -5;;
    esac
    echo " $(xbacklight | xargs printf '%.0f%%')"
}

block_power_print() {
    local plugged capacity icon
    plugged=$(< '/sys/class/power_supply/ADP1/online')
    capacity=$(< '/sys/class/power_supply/BAT0/capacity')
    if [[ "$plugged" -eq 1 ]]; then icon=''; else icon=''; fi
    if [[ "$plugged" -eq 0 && "$capacity" -le 10 ]]; then
        urgent='true'
    else
        urgent='false'
    fi
    printf '{"full_text":"%s", "urgent":%s}\n' "$icon $capacity%" "$urgent"
}

block_power() {
    block_power_print
    # alternative: timeout 30 inotifywait ...
    while inotifywait --timeout=30 -qq  /sys/class/power_supply/ADP1/uevent || :; do
        block_power_print
    done
}

"block_$1"
