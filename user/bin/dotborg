#!/bin/bash

set -o errexit -o nounset

export BORG_REPO="$HOME/Snapshots" # encryption=none

if [[ -z "${1:-}" ]]; then
    borg
    echo "
    snapshot [options]
        create partial snapshot of $HOME
    head [options]
        display name of latest archive"
elif [[ "$1" == 'snapshot' ]]; then
    time borg check --verbose --progress
    borg create --progress --stats "${@:2}" \
        '::{now:%Y-%m-%d-%H-%M-%S}'  \
        "$HOME/.dotfiles" \
        "$HOME/.dotprivate" \
        "$HOME/Documents"

    borg prune --keep-weekly=4 --keep-monthly=12 --keep-yearly=-1 --list --progress
elif [[ "$1" == 'head' ]]; then
    borg list --last=1 --format='{archive}' "${@:2}"
elif [[ "$1" == 'list' && "$*" != *'::'* ]]; then
    borg list --format='* {archive} Â· {comment}{NL}' "${@:2}"
else
    borg "$@"
fi
