#!/bin/bash

set -o errexit -o nounset

# External drive
# * p1 100% · dm-crypt w/ LUKS · ext4: home
backup_extdrive() {
    local out="/run/media/$USER/extyayaka"

    # create borg snapshot before backup
    dotborg snapshot '' 'backup_extdrive'
    dotborg check

    # rsync home
    rsync --archive --delete --protect-args --progress \
        --exclude='.cache' "$HOME" "$out"
}

# Phone SD card
# * p1 ~96 GiB · no encryption · F32: entertainment
# * p2 ~32 GiB · dm-crypt w/ LUKS · ext4: borg snapshots
backup_phone() {
    local media="/run/media/$USER"
    local uuid1='74DB-16F0'
    local uuid2crypt='0a87f529-3264-44fe-aee0-6876b833c98d'
    local uuid2plain='e52c217c-391c-424c-a2d5-382099ee2ac7'

    # rsync entertainment
    test -d "$media/$uuid1" \
        || gio mount --device="$uuid1"
    rsync --recursive --delete --protect-args --progress --size-only \
        "$HOME/Downloads" "$HOME/Music" "$HOME/.dotprivate" "$media/$uuid1"
    gio mount --unmount "file://$media/$uuid1"

    # rsync borg snapshots
    trap '' INT # Workaround: Disable SIGINT to avoid problem during passphrase
                # prompt. The device is kept busy by gvfs-udisks2-volume-monitor
                # after SIGINT (^C) even though it shouldn't.
    test -d "$media/$uuid2plain" \
        || gio mount --device="$uuid2crypt"
    trap '-' INT # restore SIGINT's default behaviour
    rsync --archive --delete --protect-args --progress \
        "$HOME/Snapshots" "$media/$uuid2plain"
    gio mount --unmount "file://$media/$uuid2plain"
}

help() {
    echo 'usage: dotbackup extdrive'
    echo '       dotbackup phone'
    exit 1
}

[[ -n "${1:-}" ]] || help
if [[ "$1" == "extdrive" ]]; then
    backup_extdrive
elif [[ "$1" == "phone" ]]; then
    backup_phone
else
    help
fi
