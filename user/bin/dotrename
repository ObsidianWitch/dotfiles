#!/usr/bin/env python3

import sys, pathlib, shutil, argparse
from subprocess import check_output as sh

def hashrename(paths, characters):
    for old_path in paths:
        old_path = pathlib.Path(old_path)
        if old_path.is_dir(): continue
        shorthash = sh(['sha1sum', old_path], text = True).split()[0][:characters]
        suffix = ''.join(old_path.suffixes)
        new_path = old_path.with_name(shorthash + suffix)

        if old_path == new_path: continue
        print(f'* {old_path} -> {new_path}')
        shutil.move(old_path, new_path)

if __name__ == '__main__':
    parser = argparse.ArgumentParser(description = 'Rename files with a shortened \
        hash to provide a (hopefully) unique filename. Preserve extensions.',
        formatter_class=argparse.ArgumentDefaultsHelpFormatter)
    parser.add_argument('paths', nargs = '+')
    parser.add_argument('--short', default=7, help='shortens hash to SHORT characters')
    args = parser.parse_args()
    hashrename(paths=args.paths, characters=args.short)
