#!/bin/bash

set -o errexit -o nounset -o xtrace

MEDIADIR="/run/media/$USER"
RUNTIMEDIR="/run/user/$UID"

SNAPSHOTS_PLAIN="$HOME/Snapshots"
SNAPSHOTS_CRYPT="$RUNTIMEDIR/gocryptfs/Snapshots"

# Mount encrypted view of $SNAPSHOTS_PLAIN to $SNAPSHOTS_CRYPT.
snapshots_mount() {
    rmdir "$SNAPSHOTS_CRYPT" || : # preventively remove empty directory to avoid syncing it
    test -d "$SNAPSHOTS_CRYPT" || {
        mkdir -p "$SNAPSHOTS_CRYPT"
        gocryptfs -reverse "$SNAPSHOTS_PLAIN" "$SNAPSHOTS_CRYPT"
    }
}
# Unmount $SNAPSHOTS_CRYPT and remove empty mountpoint.
snapshots_unmount() {
    fusermount -u "$SNAPSHOTS_CRYPT"
    rmdir "$SNAPSHOTS_CRYPT"
}

# External drive: p1 ext4 100%: dm-crypt w/ LUKS: home
backup_extdrive() {
    local uuid_crypt='5c38e9ec-be27-410c-b0ab-7e9efac8d37e'
    local uuid_plain='d51b9763-ba6a-4948-baba-b0e78cd5c28c'
    local out="$MEDIADIR/$uuid_plain"

    # create borg snapshot before backup
    time dotborg check --verbose --progress
    dotborg snapshot --comment='backup_extdrive'
    # keep 4 end-of-week archives & 1 end-of-month archive per month
    dotborg prune --keep-weekly=4 --keep-monthly=-1 --list --progress

    # rsync home
    # SIGINT (^C) is disabled as a workaround to avoid problems during passphrase
    # prompt for encrypted volumes: the device is kept busy by gvfs-udisks2-volume-monitor
    # after SIGINT even though it shouldn't.
    trap '' INT # disable SIGINT
    test -d "$out" || gio mount --device="$uuid_crypt"
    trap '-' INT # restore SIGINT's default behaviour
    rsync --archive --delete --protect-args --progress "$HOME" "$out"
    gio mount --unmount "$out"
}

# Phone SD card:
# * v1 private 25%: extension to the internal storage
# * v2 public 75%: entertainment & gocryptfs -reverse snapshots
# ```sh
# adb$ sm list-disks
# disk:179,96
# adb$ sm partition disk:179,96 mixed 75
# adb$ reboot
# ```
backup_phone() {
    local device='HMD_Global_Nokia_2.2_HZAL1670CAJ60412338'
    local out="/run/user/$UID/gvfs/mtp:host=$device/SanDisk SD card/"
    test -d "$out" || gio mount "mtp://$device"
    ( cd "$out" ) # access mount to avoid Input/output error

    snapshots_mount
    rsync --recursive --delete --protect-args --progress --size-only --inplace \
       "$HOME/Downloads/Books" "$HOME/Downloads/Learn" "$HOME/Downloads/Videos" \
       "$HOME/Music" "$SNAPSHOTS_CRYPT" "$out"
    snapshots_unmount

    gio mount --unmount "mtp://$device"
}

# Remote: gocryptfs -reverse: borg snapshots
backup_remote() {
    snapshots_mount
    rclone sync --progress "$SNAPSHOTS_CRYPT" 'remote:snapshots_crypt'
    snapshots_unmount
}

help() {
    set +o xtrace
    echo 'usage: dotbackup extdrive'
    echo '       dotbackup phone'
    echo '       dotbackup remote'
    exit 1
}

case ${1:-} in
    extdrive) backup_extdrive;;
    phone) backup_phone;;
    remote) backup_remote;;
    *) help;;
esac
