#!/usr/bin/env python3

import os
import lxml.html
import requests

class Downloader:
    def __init__(self, start_url, next_xpath, data_xpath):
        self.start_url  = start_url
        self.next_xpath = next_xpath
        self.data_xpath = data_xpath

    def start(self):
        for i, data_url in enumerate(self.iterate()):
            self.download(
                url      = data_url,
                filename = f"{i}_{os.path.basename(data_url)}",
            )

    def request(self, url): return requests.get(
        url     = url,
        headers = { "user-agent": "Mozilla/5.0" },
    )

    def download(self, url, filename):
        print(url)
        with open(filename, "wb") as file:
            data = self.request(url).content
            file.write(data)

    def iterate(self):
        next_url = self.start_url
        while next_url:
            html = self.request(next_url).content
            tree = lxml.html.fromstring(html)

            next_url = tree.xpath(self.next_xpath)
            next_url = next_url[0] if next_url else None

            data_urls = tree.xpath(self.data_xpath)
            for data_url in data_urls: yield data_url

Downloader(
    ## Sleepless Domain
    # start_url  = "http://www.sleeplessdomain.com/comic/chapter-1-cover",
    # next_xpath = "//a[@rel = 'next']/@href",
    # data_xpath = "//img[@id = 'cc-comic']/@src",

    ## The Night Belongs to Us
    # start_url  = "https://tnbtu.com/post/173553103495/01-00",
    # next_xpath = "//a[@class = 'next-button']/@href",
    # data_xpath = "//figure[@class = 'photo-hires-item correct']//img/@src",

    ## Windrose
    start_url  = "https://sparklermonthly.com/wr/windrose-chapter-01-page-001/",
    next_xpath = "//a[@rel = 'next' and not(contains(@class, 'current-webcomic'))]/@href",
    data_xpath = "//div[@class = 'webcomic-image']//img/@src",
).start()
